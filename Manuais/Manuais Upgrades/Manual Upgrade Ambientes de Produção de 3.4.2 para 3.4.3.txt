Manual Upgrade dos Ambientes de Produção de 3.4.2 para 3.4.3
============================================================

1. (i)   Apenas no caso dos servidores do Portal Cronos com o Monitorador instalado: 
         (servidor de aplicação, servidor de banco e servidor de banco de contingência):
           - Conectar como cronostech
 
   (ii)  Em todos os servidores dos fornecedores:
           - Verificar se o usuário logado é administrador ou administrator, 
             local ou da rede, abrindo e fechando cmd.exe (como administrador da rede ainda não foi testado).
             (Formaggio: user "techcorp")
 
   (ii) Em todos os servidores com versão do Integrador > 3.3.0:
           - Digitar "C:\Arquivos de Programas PC" na barra de endereços do Windows Explorer:
             (pois este diretório é "Hidden" e "Protected operating system file" desde a versão 3.3.0,
             e o arquivo de configuração foi para o menu de Windows)

                - No caso que isso talvez não é possível no Windows 2016 ou Windows 2020 ou em outra versão futura do Windows:
                  no Windows Explorer alterar a opção para exibir arquivos de sistema 
                  (desmarcar "Hide protected operating system files") temporariamente
	      

2. Fazer exatamente na seguinte sequência:
   (i)   Em todos os casos exceto JR Distribuição / Windows 10:
         Verificar se o arquivo .bat e o .jar atual estão em uso: 
         verificar o horário da última e da próxima execução no Task Scheduler 
         e verificar no taskmgr.exe se o JRE está rodando ainda. 
         Esperar até o JRE terminou.

         Observação: no caso de servidores nuvem a primeira instância roda às xx:yy horas, 
                     a segunda instância roda às xx:(yy+1) horas, etc. 
   
   (ii)  Em todos os seguintes casos:
          (a.) no caso que a frequência do processamento for 5 min ou menos
               exceto no caso JR Distribuição / Windows 10:
               (até agora apenas no servidor de banco do Portal e no servidor de contingência de banco do Portal):
          (b.) no caso de servidores nuvem quando tem 5 ou menos minutos livre depois do processamento 
               da última instância e da primeira instância: 
               
 		   - Desativar o processamento adicionando "exit" seguida por uma linha em branco 
 		     no início do arquivo Job15a15min.bat no servidor do fornecedor. 
 		     (NÃO renomear Job15a15min.bat para evitar que o Scheduler 
              possivelmente se perde comprometendo os derrubamentos automáticos dos JRE´s travados)

              Observação: no caso de servidores nuvem todas as instâncias usam o mesmo arquivo Job15a15min.bat
                          passando um parâmetro diferente para este arquivo.
              
   (iii) Em todos os casos não-nuvem nos quais a frequência do processamento for 15 min ou mais
         (incluindo no caso JR Distribuição / Windows 10):
          - Se 14 min for suficiente para fazer todos os passos do upgrade, não precisa 
            desativar o processamento.

   (iv)  Apenas no caso de instalação no servidor da JR Distribuição (Windows 10):
	        a. Primeiro verificar no diretório C:\ProgramData\PortalCronos\Logs\Local\ 
	           se o Integrador está ofertando no momento e ficar esperando até ele terminar 
	           o último passo (a atualização do arquivo TemposExecução.log)
 
		    b. Matar o processo JRE 1.8.0_92
		 		 
		   
3. (i)  Copiar o arquivo novo integr-fornecedor-3.4.3.jar do instalador para o servidor do fornecedor.
   (ii) Apagar a versão anterior integr-fornecedor-*.*.*.jar.
 


4. Copiar os seguintes arquivos do projeto Eclipse para o servidor do fornecedor:
	- bin\Versao.bat
	- bin\ComponenteTestador.bat
	- bin\CaminhoJRE.bat
	- TestadorUnitario.bat
	- Desinstalador_Integrador_ou_Monitorador.bat
	- AdicionarFornecedorNuvem.bat (apenas para servidores com Integrador Nuvem)
	- RemoverFornecedorNuvem.bat   (apenas para servidores Integrador Nuvem)

5. Apenas no caso dos servidores da Cronos (servidor de aplicação, servidor BD, servidor BD Contingência), 
   no arquivo /conf/.properties:

	   Substituir:


EnviarEmailAutomatico             = true
ProvedorEmailAutomatico           = smtps.bol.com.br
PortaEmailAutomatico              = 587
RemetenteEmailAutomatico          = portalcronos@bol.com.br
DestinoEmailAutomatico            = eric.jo@bol.com.br
CcEmailAutomatico                 =
UsuarioEmailAutomatico            = portalcronos@bol.com.br
SenhaCriptografadaEmailAutomatico = xxxxxx



		Por:


EnviarEmailAutomatico             = true
DestinoEmailAutomatico            = eric.jo@bol.com.br
CcEmailAutomatico                 =
SenhaCriptografadaEmailAutomatico = xxxxxx

# Pago:
# ProvedorEmailAutomatico           = smtps.bol.com.br
# PortaEmailAutomatico              = 587
# RemetenteEmailAutomatico          = portalcronos@bol.com.br
# UsuarioEmailAutomatico            = portalcronos@bol.com.br

# Gratuito:
ProvedorEmailAutomatico           = smtp.gmail.com
PortaEmailAutomatico              = 587
RemetenteEmailAutomatico          = portalcronos.br@gmail.com
UsuarioEmailAutomatico            = portalcronos.br@gmail.com


	 
6. Apenas no caso de servidores com o Integrador Nuvem: 
   
   (i) No arquivo TemplateNuvemAPS.properties sustituir o seguinte:

EnviarEmailAutomatico             = true
ProvedorEmailAutomatico           = smtps.bol.com.br
PortaEmailAutomatico              = 587
RemetenteEmailAutomatico          = portalcronos@bol.com.br
DestinoEmailAutomatico            = eric.jo@bol.com.br
CcEmailAutomatico                 =
UsuarioEmailAutomatico            = portalcronos@bol.com.br
SenhaCriptografadaEmailAutomatico = gzdOSeePXqyw0sWfaLtVQw==

   por:

EnviarEmailAutomatico             = true
DestinoEmailAutomatico            = eric.jo@bol.com.br
CcEmailAutomatico                 =
SenhaCriptografadaEmailAutomatico = gzdOSeePXqyw0sWfaLtVQw==

# Pago:
# ProvedorEmailAutomatico           = smtps.bol.com.br
# PortaEmailAutomatico              = 587
# RemetenteEmailAutomatico          = portalcronos@bol.com.br
# UsuarioEmailAutomatico            = portalcronos@bol.com.br

# Gratuito:
ProvedorEmailAutomatico           = smtp.gmail.com
PortaEmailAutomatico              = 587
RemetenteEmailAutomatico          = portalcronos.br@gmail.com
UsuarioEmailAutomatico            = portalcronos.br@gmail.com


    (ii) Conectar no Gmail manualmente via Firefox ou Chrome no servidor nuvem 
         para adicionar este servidor nas "recognized devices":
			- Usuário: portalcronos.br@gmail.com
			- Senha: cronos2019
			- Número de telefone: Brazil + 81 985954203 (celular de Eric, por enquanto)
    

7.  (i) Editar o conteúdo do Manual TI:
		- aumentar a versão no título
		- Substituir:

  - Houve uma atualização de Windows?
    Isso pode acabar com o serviço. Neste caso, entrar em contato com "Eric Jo" via Skype (ou com eric.jo@bol.com.br via email).

          Por:
  - Houve uma atualização de Windows?
    Isso pode travar ou até acabar com o serviço. Neste caso, reiniciar o servidor mais uma (segunda) vez,
    mesmo se o servidor já foi reinicado uma vez durante a atualização de Windows. 
    A segunda reiniciada deve ser feita SEM atualização automatica de Windows ao reiniciar o servidor.
    Se o problema ainda persistir, entrar em contato com "Eric Jo" via Skype (ou com eric.jo@bol.com.br via email).
		
	(ii)  Renomear o nome do arquivo do Manual TI (aumentar a versão de 1.5.0 para 1.5.1 e a data de 20.09.2019 para 13.09.2020)
	(iii) Editar o atalho no menu de Windows para apontar para o arquivo renomeado
	(iv)  Se precisar (depende da versão de Windows), renomear o atalho 
	(v)   Apenas no caso do Propão: 
			- Ajustar o manual "Resolver Paradas" manualmente: 
				- editar versão JRE de "jre1.8.0_92" para "jre1.8.0_261"
 


8. Apenas no caso do Propão: 
		- remover diretório C:/"Program Files"/Java/jre1.8.0_92/bin/       por completo
		- remover diretório C:/"Program Files (x86)"/Java/jre1.8.0_92/bin/ por completo


9. Apenas no caso do servidor de aplicação da Cronos, pois é o primeiro servidor a ser atualizado,
	  e já foi testado na Propão na forma de gambiarra: 
	    - no Testador Unitário TestadorSnippets.java descomentar testarParseInt() e comentar qualquer outra Test Unit.
		- executar TestadorUnitario.bat para verificar se a alteração no CaminhJRE.bat funcionou: veja TestadorUnitario.log
		- depois do teste, apagar TestadorUnitario.log


10. Apenas no caso dos servidores da Cronos (servidor de aplicação, servidor BD, servidor BD Contingência):
      - No Testador Unitário TestadorSnippets.java descomentar testarProvedorEmail() e comentar qualquer outra Test Unit. 
      - Re-gerar o .jar e copiar para o servidor e executar TestadorUnitario.bat no servidor de destino. 
      - Se o email de teste não chegar, adicionar o servidor nos "recognized devices" (dispositivos reconhecidos) 
        na conta portalcronos.br@gmail.com do Gmail via acesso no Gmail via browser. 
      - Apagar TestadorUnitario.log no servidor.


11. Apenas no caso de dois dos servidores da Cronos, no caso do servidor de BD de Produção e do servidor de BD de Contingência,
    (no servidor de aplicação não):  
      (i)  alterar o parâmetro "Debugar" para true no arquivo /conf/.properties
      (ii) alterar o Windows Schedule manualmente:
             - no servidor BD de Produção:     alterar Hora Início de 18:04:47 para 18:13:00
             - no servidor BD de Contingência: alterar Hora Início de 18:04:47 para 18:12:00


12. No caso que o processamento foi desativado: 
    remover "exit" e a linha em branco no início do arquivo Job15a15min.bat
    no servidor do fornecedor (Sempre como último passo no AnyDesk para forçar 100 % conclusão do upgrade).


13. Apenas no caso de dois dos servidores da Cronos, no caso do servidor de BD de Produção e do servidor de BD de Contingência,
    (no servidor de aplicação não):  
      (iii) acompanhar a próxima rodada
      (iv)  alterar o parâmetro "Debugar" de volta para false no arquivo /conf/.properties após os testes
      

14. Apenas no caso que não foi possível no Windows 2016 ou Windows 2020 ou em outra versão futura do Windows
    digitar "C:\Arquivos de Programas PC" na barra de endereços do Windows Explorer:
     (i)  No Windows Explorer voltar a opção para não exibir arquivos de sistema 
          (marcar "Hide protected operating system files")
     (ii) Fechar o Windows Explorer e abrir novamente

15. Em todos os casos: 
     - Acompanhar 15 minutos se o Integrador ou o Monitorador começa executar automaticamente, 
       ou 5 minutos, dependendo da frequência do processamento.
     
16. (i)   Atualizar a versão do .jar no arquivo "FornecedorRepositorio.java" para o fornecedor que foi atualizado
    (ii)  Compilar o arquivo .jar
    (iii) Atualizar o arquivo .jar no servidor de monitoramento (não precisa atualizar o servidor do fornecedor)
          esperando o processamento atual terminar primeiro
   
